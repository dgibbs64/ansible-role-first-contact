---
- name: check known_hosts for {{ inventory_hostname }}
  ansible.builtin.command: ssh-keygen -F {{ inventory_hostname }}
  register: has_entry_in_known_hosts_file
  changed_when: false
  ignore_errors: true
  delegate_to: 127.0.0.1

- name: ignore host key for {{ inventory_hostname }} on first run
  ansible.builtin.set_fact:
    ansible_ssh_common_args: "-o StrictHostKeyChecking=no"
  changed_when: false
  when: has_entry_in_known_hosts_file.rc

- name: prepare system
  block:
    - name: test connection for {{ deploy_user }}
      ansible.builtin.wait_for_connection:
        timeout: "{{ connection_timeout }}"
      register: bootstrap_connect
      changed_when: false

  rescue:
    - name: test connection for root
      remote_user: "root"
      ansible.builtin.wait_for_connection:
        timeout: "{{ connection_timeout }}"
      register: bootstrap_connect

    - name: configure "{{ deploy_user }}" user
      remote_user: "root"
      block:
        - name: generate a random password
          ansible.builtin.set_fact:
            deploy_password: "{{ lookup('password', '/dev/null length=16 chars=ascii_letters,digits') }}"

        - name: ensure "{{ deploy_user }}" user exists
          ansible.builtin.user:
            name: "{{ deploy_user }}"
            shell: /bin/bash
            create_home: true
            password: "{{ deploy_password | password_hash('sha512') }}"
            update_password: on_create

        - name: ensure ssh public key for "{{ deploy_user }}" user is on node
          ansible.posix.authorized_key:
            user: "{{ deploy_user }}"
            state: present
            key: "{{ lookup('file', '{{ ssh_key_location }}') }}"

        - name: add user "{{ deploy_user }}" to sudo
          become: true
          ansible.builtin.lineinfile:
            path: /etc/sudoers.d/{{ deploy_user }}
            line: "{{ deploy_user }} ALL=(ALL) NOPASSWD: ALL"
            state: present
            mode: 0440
            create: true
            validate: "visudo -cf %s"

        - name: Set includedir in sudoers
          become: true
          ansible.builtin.lineinfile:
            dest: /etc/sudoers
            line: "#includedir /etc/sudoers.d"
            state: present
            validate: "/usr/sbin/visudo -cf %s"
